import{spawn as s,execSync as e,exec as t}from"child_process";import o from"fs";import r from"os";const a=process.env.hasOwnProperty("REPL_OWNER")?"replit":process.env.hasOwnProperty("CSB_SANDBOX_ID")?"csb":r.platform();import n from"readline";const i=["⠋","⠙","⠹","⠸","⠼","⠴","⠦","⠧","⠇","⠏"];process.stdout.isTTY||(process.stdout.clearLine=function(){console.log("")},process.stdout.cursorTo=function(){console.log("")});let c=JSON.parse(o.readFileSync("package.json"));if(c.compiled!=a)for(const s of["chalk","moment-timezone"])e("npm install "+s+"@latest");import{fileURLToPath as l}from"url";import{dirname as p,join as m}from"path";const d=p(l(import.meta.url));let u={};(async()=>{const r=await import("./system/lib/index.js"),l=function(s,e){let a=!0;return new Promise((n=>{if(void 0===e||""==e){process.stdout.clearLine(),process.stdout.cursorTo(0);let e=0,c=setInterval((()=>{e>=i.length&&(e=0),r.animation("Installing "+s+" "+i[e++])}),100);t("npm i "+s,(async(e,t,i)=>{clearInterval(c),!JSON.parse(await o.promises.readFile(d+"/package.json")).dependencies.hasOwnProperty(s)&&i&&(process.stdout.clearLine(),process.stdout.cursorTo(0),a=!1,r.sys("Installation failed "+s+" \n"+i.trim())),process.stdout.clearLine(),process.stdout.cursorTo(0),n(a)}))}else{process.stdout.clearLine(),process.stdout.cursorTo(0);let c=0,l=setInterval((()=>{c>=i.length&&(c=0),r.animation("Installing "+s+"@"+e.replace(/\^|@/g,"")+" "+i[c++])}),100);t("npm i "+s+"@"+e.replace(/\^|@/g,""),(async(t,i,c)=>{clearInterval(l),!JSON.parse(await o.promises.readFile(d+"/package.json")).dependencies.hasOwnProperty(s)&&c&&(process.stdout.clearLine(),process.stdout.cursorTo(0),r.sys("Installation failed "+s+"@"+e.replace(/\^|@/g,"")+" \n"+c.trim()),a=!1),process.stdout.clearLine(),process.stdout.cursorTo(0),n(a)}))}}))};let p=["ansi-to-html","axios","better-sqlite3","compression","cookie-parser","express","fca-umaru-v1","fca-umaru-v2","fs-extra","helmet","msgpackr","node-cron","pm2","ws"];if(c.compiled==a||process.env.hasOwnProperty("REPL_OWNER")||process.env.hasOwnProperty("CSB_SANDBOX_ID")||process.stdout.isTTY){if(c.compiled!=a){for(const h of p)await l(h);c=JSON.parse(await o.promises.readFile("package.json")),c.compiled=a,await o.promises.writeFile("package.json",JSON.stringify(c,null,"\t"))}}else{p=["ansi-to-html","axios","compression","cookie-parser","express","fca-umaru-v1","fca-umaru-v2","fs-extra","helmet","msgpackr","node-cron","ws"],"android"==a&&e("pkg install ffmpeg -y && pkg install python -y && pkg install make -y && pkg install clang -y && pkg install binutils -y");for(const S of p)await l(S);await new Promise((s=>{const e=n.createInterface({input:process.stdin,output:process.stdout});e.question(r.logValue("Umaru","Do you want to install sqlite database? [Y/n] "),(async t=>{t.toLowerCase().startsWith("y")?(await l("better-sqlite3"),(t=JSON.parse(await o.promises.readFile("./config.json"))).SqliteDB=!0,await o.promises.writeFile("./config.json",JSON.stringify(t,null,"\t"))):((t=JSON.parse(await o.promises.readFile("./config.json"))).SqliteDB=!1,await o.promises.writeFile("./config.json",JSON.stringify(t,null,"\t"))),e.close(),s()}))})),c=JSON.parse(await o.promises.readFile("package.json")),c.compiled=a,await o.promises.writeFile("package.json",JSON.stringify(c,null,"\t"))}const m=(await import("express")).default;if(!(process.env.hasOwnProperty("REPL_OWNER")||process.env.hasOwnProperty("CSB_SANDBOX_ID")||process.stdout.isTTY)){const O=function(s){return new Promise(((e,t)=>{try{let r=o.createReadStream(s),a=[];r.on("data",(s=>{a.push(s)})),r.on("end",(async()=>{e(Buffer.concat(a))})),r.on("error",(s=>{t(s)}))}catch(s){t(s)}}))};try{u=JSON.parse(await O("./config.json")),await o.promises.copyFile("./config.json","./system/config.json.backup")}catch(k){if(!o.existsSync("./system/config.json.backup"))return r.sys("config.json not found");await o.promises.copyFile("./system/config.json.backup",umaru.configPath)}o.watch("./config.json",(async()=>{try{u=JSON.parse(await O("./config.json"))}catch{}}));const N=m();function f(s){return N.listen(s,(async()=>{u.currentMainPort=j.address().port,await o.promises.writeFile("./config.json",JSON.stringify(u,null,"\t"))}))}N.use(((s,e,t)=>{"/url"===s.originalUrl?e.send(u.dashboard).end():e.redirect(u.dashboard+s.originalUrl)}));let j=f(u.PORT);j.on("error",(()=>{j=f(0)}))}let g=process.cwd(),y=process.cwd()+"/system";function w(s,e){let t=e.split(/\/|\\/).filter((s=>""!==s)),r="";r+=s;for(const s of t)r+="/"+s,o.existsSync(r)||o.mkdirSync(r)}w(g,"acct"),w(g,"bin"),w(g,"data/Threads"),w(g,"data/Users"),w(g,"storage/emulated/0"),w(g,"storage/emulated/0/Pictures"),w(g,"storage/emulated/0/Music"),w(g,"storage/emulated/0/Movies"),w(g,"storage/emulated/0/Download"),await o.promises.writeFile("./bin/log",""),w(y,"app/commands/cache"),w(y,"app/commands/noprefix"),w(y,"app/commands/shortcut"),w(y,"etc/languages"),function e(){let t=JSON.parse(o.readFileSync("package.json"));if(t.scripts.start.startsWith("node")&&(process.env.hasOwnProperty("REPL_OWNER")||process.env.hasOwnProperty("CSB_SANDBOX_ID")))return t.scripts.start="pm2 kill && pm2 start index.js -i 1 --no-daemon",o.writeFileSync("package.json",JSON.stringify(t,null,"\t")),s("npm",["start"],{stdio:"inherit",cwd:d,shell:!0});if(t.scripts.start.startsWith("pm2")&&!process.env.hasOwnProperty("REPL_OWNER")&&!process.env.hasOwnProperty("CSB_SANDBOX_ID"))return t.scripts.start="node index",o.writeFileSync("package.json",JSON.stringify(t,null,"\t")),s("npm",["start"],{stdio:"inherit",cwd:d,shell:!0});o.writeFileSync(process.cwd()+"/bin/log","");const a=s("node",["umaru.js"],{stdio:"inherit",cwd:d+"/system",shell:!0});a.on("close",(async s=>0==s?r.sys("Shutdown"):1==s?(r.sys("Restarting..."),e()):void 0)),a.on("error",(function(s){r("[ System ] An error occurred: "+JSON.stringify(s))}))}()})();